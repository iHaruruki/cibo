# カメラキャリブレーション - Cibo Package

このパッケージは8x6チェスボードを使用して2台のカメラ間のキャリブレーションを行い、TF（Transform）の設定を自動化します。

## 概要

- **チェスボードサイズ**: 8x6 (内部コーナー数)
- **チェスボード1マスサイズ**: 25mm (設定可能)
- **対応カメラ**: 2台のRGBDカメラ
- **出力**: カメラ間の変換行列、距離、TF配信

## 機能

1. **リアルタイムチェスボード検出**
2. **ステレオキャリブレーション**
3. **カメラ間距離の計算**
4. **継続的なTF配信**
5. **結果の保存・読み込み**

## セットアップ

### 1. パッケージのビルド

```bash
cd ~/ros2_ws
colcon build --packages-select cibo
source install/setup.bash
```

### 2. チェスボードの準備

8x6のチェスボード（内部コーナー数）を印刷し、平らな板に貼り付けてください。
デフォルトでは1マス25mmに設定されています。

## 使用方法

### 1. キャリブレーションノードの起動

```bash
# 基本的な起動
ros2 run cibo camera_calibration_node

# またはlaunchファイルを使用
ros2 launch cibo camera_calibration_launch.py
```

### 2. カメラトピックの確認

以下のトピックが配信されていることを確認してください：
- `/camera_01/color/image_raw`
- `/camera_01/depth/image_raw`
- `/camera_02/color/image_raw`
- `/camera_02/depth/image_raw`

異なるトピック名を使用している場合は、launchファイルでリマッピングしてください。

### 3. キャリブレーション手順

1. **チェスボード検出確認**: 両カメラでチェスボードが検出されることを確認
2. **データ収集**: 
   - チェスボードを様々な角度・位置で表示
   - **スペースキー**を押してデータを保存
   - 最低5組のデータが必要（推奨: 10-20組）
3. **キャリブレーション実行**: **Cキー**を押してキャリブレーション実行
4. **結果保存**: **Sキー**を押して結果を保存

### 4. 操作キー

| キー | 機能 |
|------|------|
| スペース | 現在のチェスボード検出結果を保存 |
| C | キャリブレーション実行 |
| R | データリセット |
| S | 結果保存 |
| L | 保存済み結果読み込み |
| Q | 終了 |

## 出力情報

### 1. TFフレーム

- `camera_01_link` ← `camera_02_link` の変換を配信
- 継続的に10Hzで配信（キャリブレーション完了後）

### 2. カメラ間距離

- 2台のカメラ間の直線距離をミリメートル単位で表示
- 画面とログに表示

### 3. 保存ファイル

- ファイル: `~/chessboard_calibration_result.json`
- 内容: 変換行列、内部パラメータ、距離など

## トピック

### 購読トピック

- `/camera_01/color/image_raw` (sensor_msgs/Image)
- `/camera_01/depth/image_raw` (sensor_msgs/Image)
- `/camera_02/color/image_raw` (sensor_msgs/Image)
- `/camera_02/depth/image_raw` (sensor_msgs/Image)

### 配信トピック

- `/calibration/status` (std_msgs/Bool): キャリブレーション状態
- `/tf` (tf2_msgs/TFMessage): カメラ間の変換

## パラメータ設定

コード内で以下のパラメータを変更可能です：

```python
# チェスボードパラメータ
self.chessboard_size = (8, 6)  # 内部コーナー数 (横, 縦)
self.square_size = 25.0  # チェスボードの1マスのサイズ (mm)
```

## トラブルシューティング

### チェスボードが検出されない場合

1. **照明条件の確認**: 十分な照明があることを確認
2. **チェスボードの品質**: 印刷品質とコントラストを確認
3. **カメラ位置**: チェスボード全体がカメラの視野内にあることを確認
4. **焦点**: カメラの焦点が合っていることを確認

### キャリブレーション精度が低い場合

1. **データ数を増やす**: より多くの角度・位置でデータを収集
2. **チェスボードの角度**: 様々な角度（傾き、回転）でデータを収集
3. **距離の変化**: チェスボードとカメラの距離を変えてデータを収集

### TFが配信されない場合

1. **キャリブレーション完了の確認**: 画面に"Calibrated: YES"が表示されることを確認
2. **TFトピックの確認**: `ros2 topic echo /tf`で確認
3. **ログの確認**: エラーメッセージがないか確認

## 自動化

起動時に保存済みの結果を自動読み込みする場合：

```bash
ros2 launch cibo camera_calibration_launch.py auto_load_calibration:=true
```

## 結果の確認

### TFの確認

```bash
# TFツリーの表示
ros2 run tf2_tools view_frames

# 特定の変換の確認
ros2 run tf2_ros tf2_echo camera_01_link camera_02_link
```

### RVizでの可視化

```bash
ros2 launch cibo camera_calibration_launch.py use_rviz:=true
```

## 注意事項

1. チェスボードは平らな面に正確に貼り付けてください
2. キャリブレーション中はカメラを動かさないでください
3. 様々な角度・位置でデータを収集することが精度向上に重要です
4. キャリブレーション結果は自動的に保存されます
